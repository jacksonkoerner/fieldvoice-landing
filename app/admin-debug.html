<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FieldVoice Pro - Admin Debug</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./js/config.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dot-navy': '#0a1628',
                        'dot-blue': '#1e3a5f',
                        'dot-orange': '#ea580c',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dot-navy min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-white">üõ†Ô∏è Admin Debug Tools</h1>
            <a href="index.html" class="text-blue-400 hover:text-blue-300">
                <i class="fas fa-home"></i> Back to Home
            </a>
        </div>

        <!-- localStorage Section -->
        <div class="bg-white rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-bold">üì¶ localStorage Keys</h2>
                <button onclick="clearAllLocalStorage()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm">
                    Clear All fvp_* Keys
                </button>
            </div>
            <pre id="localStorageDisplay" class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-48 font-mono"></pre>
        </div>

        <!-- Reports Section -->
        <div class="bg-white rounded-lg p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-bold">üìã All Reports</h2>
                <button onclick="loadReports()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-refresh"></i> Refresh
                </button>
            </div>
            <div id="reportsContainer" class="space-y-2"></div>
        </div>

        <!-- Danger Zone -->
        <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
            <h2 class="text-lg font-bold text-red-700 mb-3">‚ö†Ô∏è Danger Zone</h2>
            <div class="flex gap-2 flex-wrap">
                <button onclick="deleteAllReports()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                    Delete ALL Reports
                </button>
                <button onclick="resetAllToDraft()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">
                    Reset All to Draft
                </button>
            </div>
        </div>

        <!-- Quick Info -->
        <div class="mt-4 text-gray-400 text-sm">
            <p><strong>Status Flow:</strong> draft ‚Üí refined ‚Üí submitted ‚Üí finalized</p>
            <p><strong>Archives shows:</strong> submitted and finalized reports</p>
            <p><strong>Note:</strong> Deleting a report cascades to all related tables automatically</p>
        </div>
    </div>

    <script>
        // Load localStorage display
        function displayLocalStorage() {
            const container = document.getElementById('localStorageDisplay');
            const fvpKeys = {};

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('fvp_')) {
                    try {
                        const value = localStorage.getItem(key);
                        // Try to parse JSON, show preview if too long
                        try {
                            const parsed = JSON.parse(value);
                            fvpKeys[key] = parsed;
                        } catch {
                            fvpKeys[key] = value.length > 100 ? value.substring(0, 100) + '...' : value;
                        }
                    } catch (e) {
                        fvpKeys[key] = '[Error reading]';
                    }
                }
            }

            if (Object.keys(fvpKeys).length === 0) {
                container.textContent = 'No fvp_* keys found in localStorage';
            } else {
                container.textContent = JSON.stringify(fvpKeys, null, 2);
            }
        }

        // Clear all fvp_* localStorage keys
        function clearAllLocalStorage() {
            if (!confirm('Clear all fvp_* localStorage keys?')) return;

            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('fvp_')) {
                    keysToRemove.push(key);
                }
            }

            keysToRemove.forEach(key => localStorage.removeItem(key));
            alert(`Cleared ${keysToRemove.length} keys`);
            displayLocalStorage();
        }

        // Load reports from Supabase
        async function loadReports() {
            const container = document.getElementById('reportsContainer');
            container.innerHTML = '<p class="text-gray-500">Loading...</p>';

            try {
                const { data: reports, error } = await supabaseClient
                    .from('reports')
                    .select(`
                        id,
                        report_date,
                        status,
                        inspector_name,
                        created_at,
                        projects (
                            project_name
                        )
                    `)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!reports || reports.length === 0) {
                    container.innerHTML = '<p class="text-gray-500">No reports found</p>';
                    return;
                }

                container.innerHTML = reports.map(r => `
                    <div class="border rounded p-3 flex items-center justify-between bg-gray-50">
                        <div>
                            <div class="font-medium">${r.projects?.project_name || 'Unknown Project'}</div>
                            <div class="text-sm text-gray-600">
                                ${r.report_date} ‚Ä¢
                                <span class="inline-block px-2 py-0.5 rounded text-xs font-medium ${getStatusColor(r.status)}">${r.status}</span>
                            </div>
                            <div class="text-xs text-gray-400">${r.id}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="resetToDraft('${r.id}')" class="text-yellow-600 hover:text-yellow-800 px-2 py-1" title="Reset to Draft">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button onclick="deleteReport('${r.id}')" class="text-red-600 hover:text-red-800 px-2 py-1" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                container.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`;
            }
        }

        function getStatusColor(status) {
            switch(status) {
                case 'draft': return 'bg-gray-200 text-gray-700';
                case 'refined': return 'bg-blue-200 text-blue-700';
                case 'submitted': return 'bg-green-200 text-green-700';
                case 'finalized': return 'bg-purple-200 text-purple-700';
                default: return 'bg-gray-200 text-gray-700';
            }
        }

        // Delete a single report (cascade handles related data)
        async function deleteReport(reportId) {
            if (!confirm('Delete this report? This cannot be undone.')) return;

            try {
                const { error } = await supabaseClient
                    .from('reports')
                    .delete()
                    .eq('id', reportId);

                if (error) throw error;

                alert('Report deleted');
                loadReports();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Reset a report to draft status
        async function resetToDraft(reportId) {
            if (!confirm('Reset this report to draft status?')) return;

            try {
                const { error } = await supabaseClient
                    .from('reports')
                    .update({ status: 'draft' })
                    .eq('id', reportId);

                if (error) throw error;

                alert('Report reset to draft');
                loadReports();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Delete ALL reports
        async function deleteAllReports() {
            if (!confirm('DELETE ALL REPORTS? This cannot be undone!')) return;
            if (!confirm('Are you REALLY sure?')) return;

            try {
                const { error } = await supabaseClient
                    .from('reports')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all

                if (error) throw error;

                alert('All reports deleted');
                loadReports();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Reset all reports to draft
        async function resetAllToDraft() {
            if (!confirm('Reset ALL reports to draft status?')) return;

            try {
                const { error } = await supabaseClient
                    .from('reports')
                    .update({ status: 'draft' })
                    .neq('id', '00000000-0000-0000-0000-000000000000');

                if (error) throw error;

                alert('All reports reset to draft');
                loadReports();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            displayLocalStorage();
            loadReports();
        });
    </script>
</body>
</html>
